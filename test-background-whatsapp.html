<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Background WhatsApp Download Test</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #1a1a1a;
            color: white;
        }
        .event { 
            margin: 10px 0; 
            padding: 10px; 
            background: #2a2a2a; 
            border-radius: 5px; 
        }
        .success { background: #2d5a2d; }
        .error { background: #5a2d2d; }
        .info { background: #2d4a5a; }
        .available { background: #1a4a2a; }
        .not-available { background: #4a2a1a; }
        button { 
            margin: 5px; 
            padding: 10px 15px; 
            cursor: pointer;
            background: #4a4a4a;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:hover { background: #5a5a5a; }
        input {
            padding: 8px;
            margin: 5px;
            background: #3a3a3a;
            color: white;
            border: 1px solid #5a5a5a;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>🧪 Background WhatsApp Download & Face Validation Test</h1>
    
    <div>
        <h3>Test Background WhatsApp Download with Face Validation</h3>
        <button onclick="testBackgroundDownload()">🔄 Start Background Download Test</button>
        <p><em>This will test the new background download system that validates faces before making WhatsApp images available to users.</em></p>
    </div>

    <div id="events"></div>

    <script>
        const socket = io();
        let testDeviceId = null;
        let testUserId = null;

        function addEvent(message, type = 'info') {
            const eventsDiv = document.getElementById('events');
            const eventDiv = document.createElement('div');
            eventDiv.className = `event ${type}`;
            eventDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            eventsDiv.appendChild(eventDiv);
            eventsDiv.scrollTop = eventsDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Socket event listeners
        socket.on('connect', () => {
            addEvent('✅ Connected to server', 'success');
        });

        socket.on('disconnect', (reason) => {
            addEvent('❌ Disconnected: ' + reason, 'error');
        });

        socket.on('device_registered', (data) => {
            addEvent('📱 Device registered: ' + JSON.stringify(data, null, 2), 'success');
            testDeviceId = data.deviceId;
            testUserId = data.userId;
        });

        socket.on('background_whatsapp_status', (data) => {
            const available = data.available;
            const type = available ? 'available' : 'not-available';
            
            addEvent(`📊 Background WhatsApp Status: Available: ${available ? '✅ YES' : '❌ NO'}`, type);
            addEvent(`📝 Message: ${data.message}`, type);
            
            if (data.validationDetails) {
                addEvent(`🔍 Face Validation: ${JSON.stringify(data.validationDetails, null, 2)}`, type);
            }
            
            if (available) {
                addEvent('🎉 WhatsApp button would be SHOWN to user', 'success');
            } else {
                addEvent('🚫 WhatsApp button would be HIDDEN from user', 'error');
            }
        });

        socket.on('error', (data) => {
            addEvent('❌ General error: ' + JSON.stringify(data, null, 2), 'error');
        });

        // Log all events
        socket.onAny((eventName, ...args) => {
            console.log(`Event ${eventName}:`, args);
        });

        function testBackgroundDownload() {
            addEvent('🧪 Starting background WhatsApp download test...', 'info');
            
            // Create a test device first
            const deviceId = 'test-bg-whatsapp-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            addEvent(`📱 Creating test device: ${deviceId}`, 'info');
            
            // Register the device
            socket.emit('register_device', { deviceId });
            
            // Set up a complete user profile with the existing phone number that has WhatsApp image
            setTimeout(() => {
                addEvent('👤 Setting up test user with existing WhatsApp image...', 'info');
                socket.emit('submit_phone_number', { phoneNumber: '+972523737233' }); // This phone has cached image
                
                setTimeout(() => {
                    socket.emit('verify_2fa_code', { code: '123456' });
                    
                    setTimeout(() => {
                        socket.emit('save_email', { email: 'test@example.com' });
                        
                        setTimeout(() => {
                            socket.emit('save_user_name', { name: 'Test User' });
                            
                            setTimeout(() => {
                                socket.emit('save_user_gender', { 
                                    gender: 'male', 
                                    userId: testUserId,
                                    name: 'Test User'
                                });
                                
                                setTimeout(() => {
                                    addEvent('🔄 Triggering background WhatsApp download...', 'info');
                                    socket.emit('background_whatsapp_download', {});
                                }, 500);
                            }, 500);
                        }, 500);
                    }, 500);
                }, 500);
            }, 1000);
        }
    </script>
</body>
</html>
